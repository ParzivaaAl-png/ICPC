<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –≤—ã–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞</title>
<style>
:root{
  --bg:#07101a; --panel: rgba(18,24,33,0.56);
  --accent1:#45a8ff; --accent2:#2aa1ff; --muted:#98a0b3; --text:#e6eef8;
  --danger1:#ff4757; --danger2:#ff3838; /* –ö—Ä–∞—Å–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è */
  --card-shadow: 0 12px 30px rgba(2,6,23,0.6);
}
.light{ --bg:#f5f7fb; --panel: rgba(255,255,255,0.92); --text:#081026; --muted:#52606d; --accent1:#2979ff; --accent2:#1e66d7; --danger1:#ff4757; --danger2:#ff3838; }

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:var(--text);background:linear-gradient(180deg,var(--bg), #061018);-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:28px auto;padding:18px}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-radius:14px;background:var(--panel);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.03);box-shadow:var(--card-shadow)}
.title{font-weight:800;font-size:22px}
.subtitle{color:var(--muted);font-size:13px}

.card{margin-top:16px;padding:20px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:var(--card-shadow)}
.progress-row{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.progress-small{font-size:13px;color:var(--muted);min-width:180px}
.progress-track{flex:1;height:8px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent1),var(--accent2));transition:width .35s ease}
.progress-pct{width:48px;text-align:right;color:var(--muted);font-size:13px}

.question{font-size:20px;font-weight:700;margin-bottom:12px;color:var(--text)}
.options{display:flex;flex-direction:column;gap:10px}
.option{display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);cursor:pointer;transition:transform .16s ease,box-shadow .16s, background .16s;user-select:none}
.option:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.55)}
.option .opt-text{flex:1;font-size:15px;color:var(--text)}
.option.selected{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border-color:transparent;box-shadow:0 12px 30px rgba(45,166,255,0.14)}
.option.correct{background:linear-gradient(90deg,#2ecc71,#1fbf5b);color:#fff}
.option.incorrect{background:linear-gradient(90deg,#ff6b6b,#ff4b4b);color:#fff}

.meta{display:flex;align-items:center;justify-content:space-between;margin-top:12px}
.feedback{padding:10px 12px;border-radius:10px;display:none;font-weight:700}
.feedback.correct{background:rgba(46,204,113,0.12);color:#2ecc71}
.feedback.incorrect{background:rgba(255,107,107,0.12);color:#ff6b6b}
.explain{margin-left:12px;color:var(--muted);display:none}

.nav{display:flex;align-items:center;gap:12px;justify-content:flex-end;margin-top:18px}
.btn{padding:10px 16px;border-radius:12px;border:none;background:var(--accent1);color:white;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
.btn.danger{background:linear-gradient(90deg,var(--danger1),var(--danger2));color:white;border:none}
.btn.danger:hover{background:linear-gradient(90deg,#ff3838,#ff1e1e)}
.btn:disabled{opacity:0.45;cursor:not-allowed}
.auto-skip-toggle{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px;cursor:pointer}
.auto-skip-toggle input{transform:scale(1.12)}

.bottom-cell { margin-top:22px; display:none; } /* hidden by default */
.bottom-cell.visible { display:block; }  /* visible when active */
.bottom-cell .track {
  width:100%; height:12px; border-radius:8px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.03); overflow:hidden; position:relative; box-shadow: 0 8px 20px rgba(2,6,23,0.45);
}
.bottom-cell .fill { height:100%; width:0%; background: linear-gradient(90deg,var(--accent1),var(--accent2)); transition: width .05s linear; border-radius:6px; box-shadow:0 6px 16px rgba(45,166,255,0.14); }
.bottom-cell .label { margin-top:8px; text-align:right; color:var(--muted); font-size:13px; }

.results{padding:22px;text-align:center;color:var(--text);display:none}
.score{font-size:36px;font-weight:800;margin-bottom:8px}
.result-details{margin:20px 0;padding:15px;background:rgba(255,255,255,0.02);border-radius:10px;}
.result-details div{margin:5px 0;}

.start-modal{position:fixed;inset:0;background:linear-gradient(rgba(3,6,10,0.6), rgba(3,6,10,0.6));display:flex;align-items:center;justify-content:center;z-index:2000}
.start-card{background:var(--panel);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.04);width:360px;box-shadow:var(--card-shadow)}
.mode-btn{width:100%;padding:12px;border-radius:10px;border:none;margin-bottom:10px;font-weight:700;cursor:pointer}
.mode-single{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white}
.mode-mastery{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
.subject-btn{width:100%;padding:12px;border-radius:10px;border:none;margin-bottom:10px;font-weight:700;cursor:pointer;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);text-align:left}
.subject-btn:hover{background:rgba(255,255,255,0.05)}
.subject-btn.selected{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white}

.confirm-modal{position:fixed;inset:0;background:linear-gradient(rgba(3,6,10,0.8), rgba(3,6,10,0.8));display:flex;align-items:center;justify-content:center;z-index:3000;display:none}
.confirm-card{background:var(--panel);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.04);width:360px;box-shadow:var(--card-shadow);text-align:center}
.confirm-buttons{display:flex;gap:10px;margin-top:20px}
.confirm-buttons button{flex:1}

@media(max-width:560px){ .bottom-cell .label{display:none} .bottom-cell .track{height:10px} }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title" id="testTitle">–í—ã–±–æ—Ä —Ç–µ—Å—Ç–∞</div>
        <div class="subtitle" id="testSubtitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>
      </div>
      <div>
        <button id="themeBtn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer">–¢–µ–º–∞</button>
      </div>
    </div>

    <div class="card">
      <div class="progress-row">
        <div class="progress-small" id="psmall">–í–æ–ø—Ä–æ—Å 1 –∏–∑ N</div>
        <div class="progress-track"><div id="progressBar" class="progress-bar"></div></div>
        <div class="progress-pct" id="ppct">0%</div>
      </div>

      <div>
        <div class="question" id="qtext">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div class="options" id="options"></div>

        <div class="meta">
          <div id="feedback" class="feedback"></div>
          <div id="explain" class="explain"></div>
        </div>
      </div>

      <div class="nav">
        <button id="prevBtn" class="btn ghost">–ù–∞–∑–∞–¥</button>
        
        <button id="finishBtn" class="btn danger" style="display:none">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç</button>

        <label class="auto-skip-toggle" title="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ ‚Äî –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–Ω–∏–π –±–∞—Ä –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">
          <input type="checkbox" id="autoSkip" />
          <span>–ê–≤—Ç–æ–ø—Ä–æ–ø—É—Å–∫</span>
        </label>

        <button id="actionBtn" class="btn">–°–ª–µ–¥—É—é—â–∏–π</button>
      </div>

      <!-- –æ—Ç–¥–µ–ª—å–Ω–∞—è —è—á–µ–π–∫–∞ –≤–Ω–∏–∑—É —Å –±–∞—Ä–æ–º -->
      <div class="bottom-cell" id="bottomCell" aria-hidden="true">
        <div class="track"><div class="fill" id="bottomFill"></div></div>
        <div class="label" id="bottomLabel">0%</div>
      </div>

      <div id="results" class="results">
        <h2>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</h2>
        <div class="score" id="finalScore">0/0</div>
        <div id="resultMessage"></div>
        
        <div class="result-details">
          <div>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="correctAnswers">0</span></div>
          <div>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="wrongAnswers">0</span></div>
          <div>–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span id="percentage">0%</span></div>
          <div>–ü—Ä–æ–π–¥–µ–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–≤: <span id="totalAnswered">0</span></div>
        </div>
        
        <div style="margin-top:14px">
          <button id="restartBtn" class="btn">–ü—Ä–æ–π—Ç–∏ —Å–Ω–æ–≤–∞</button>
          <button id="backToSubjectsBtn" class="btn ghost" style="margin-left:8px">–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ç–µ—Å—Ç</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ -->
  <div class="confirm-modal" id="confirmModal">
    <div class="confirm-card">
      <h3>–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç?</h3>
      <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç –¥–æ—Å—Ä–æ—á–Ω–æ? –í—Å–µ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.</p>
      <div class="confirm-buttons">
        <button id="confirmCancelBtn" class="btn ghost">–û—Ç–º–µ–Ω–∞</button>
        <button id="confirmFinishBtn" class="btn danger">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="start-modal" id="startModal">
    <div class="start-card">
      <h2 id="modalTitle">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</h2>
      <div id="subjectList">
        <!-- –ü—Ä–µ–¥–º–µ—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
      </div>
      <div id="modeChoice" style="display: none;">
        <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</p>
        <button id="singleBtn" class="mode-btn mode-single">–ü—Ä–æ–π—Ç–∏ –æ–¥–∏–Ω —Ä–∞–∑</button>
        <button id="masteryBtn" class="mode-btn mode-mastery">Mastery ‚Äî –ø–æ–≤—Ç–æ—Ä—è—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–µ</button>
        <button id="backToSubjectsBtn2" class="btn ghost" style="margin-top:10px;width:100%">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –ø—Ä–µ–¥–º–µ—Ç–∞</button>
      </div>
    </div>
  </div>

<script>
// ====== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ======
let mode = 'single';
let selectedSubject = '';
let currentQuestions = [];
let order = [];
let currentIndex = 0;
let score = 0;
let answered = false;
let userSelections = {};
let totalQuestionsInTest = 0; // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ —Ç–µ—Å—Ç–µ
let questionsAnswered = 0; // –°–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç–≤–µ—á–µ–Ω–æ

// bottom state
let bottomAnim = null;
let bottomStart = null;
let bottomDuration = 0;
let bottomActive = false;

// ====== –°–û–•–†–ê–ù–ï–ù–ò–ï –°–û–°–¢–û–Ø–ù–ò–Ø –í LOCALSTORAGE ======
function saveState() {
  const state = {
    mode,
    selectedSubject,
    order,
    currentIndex,
    score,
    answered,
    userSelections,
    totalQuestionsInTest,
    questionsAnswered
  };
  localStorage.setItem('testState', JSON.stringify(state));
}

function loadState() {
  const saved = localStorage.getItem('testState');
  if (saved) {
    try {
      const state = JSON.parse(saved);
      return state;
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', e);
      return null;
    }
  }
  return null;
}

function clearState() {
  localStorage.removeItem('testState');
}

// ====== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ======
function shuffleInPlace(a){ 
  for(let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  } 
  return a; 
}

function shuffled(a){ 
  return shuffleInPlace(a.slice()); 
}

function isMulti(q){ 
  return Array.isArray(q.correctAnswers) && q.correctAnswers.length > 1; 
}

// ====== –≠–õ–ï–ú–ï–ù–¢–´ DOM ======
const qtext = document.getElementById('qtext');
const optionsEl = document.getElementById('options');
const prevBtn = document.getElementById('prevBtn');
const actionBtn = document.getElementById('actionBtn');
const finishBtn = document.getElementById('finishBtn');
const progressBar = document.getElementById('progressBar');
const psmall = document.getElementById('psmall');
const ppct = document.getElementById('ppct');
const feedbackEl = document.getElementById('feedback');
const explainEl = document.getElementById('explain');
const resultsEl = document.getElementById('results');
const finalScore = document.getElementById('finalScore');
const resultMessage = document.getElementById('resultMessage');
const correctAnswersEl = document.getElementById('correctAnswers');
const wrongAnswersEl = document.getElementById('wrongAnswers');
const percentageEl = document.getElementById('percentage');
const totalAnsweredEl = document.getElementById('totalAnswered');
const startModal = document.getElementById('startModal');
const subjectListEl = document.getElementById('subjectList');
const modeChoiceEl = document.getElementById('modeChoice');
const modalTitle = document.getElementById('modalTitle');
const singleBtn = document.getElementById('singleBtn');
const masteryBtn = document.getElementById('masteryBtn');
const autoSkipEl = document.getElementById('autoSkip');
const bottomCell = document.getElementById('bottomCell');
const bottomFill = document.getElementById('bottomFill');
const bottomLabel = document.getElementById('bottomLabel');
const restartBtn = document.getElementById('restartBtn');
const backToSubjectsBtn = document.getElementById('backToSubjectsBtn');
const backToSubjectsBtn2 = document.getElementById('backToSubjectsBtn2');
const themeBtn = document.getElementById('themeBtn');
const testTitle = document.getElementById('testTitle');
const testSubtitle = document.getElementById('testSubtitle');
const confirmModal = document.getElementById('confirmModal');
const confirmCancelBtn = document.getElementById('confirmCancelBtn');
const confirmFinishBtn = document.getElementById('confirmFinishBtn');

// ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–´–ë–û–†–ê –ü–†–ï–î–ú–ï–¢–û–í ======
function initSubjectSelection() {
  subjectListEl.innerHTML = '';
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  const subjects = ['Spring Framework', '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ü–û', '–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å'];
  
  subjects.forEach(subject => {
    const btn = document.createElement('button');
    btn.className = 'subject-btn';
    btn.textContent = subject;
    btn.dataset.subject = subject;
    
    btn.addEventListener('click', () => {
      document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedSubject = subject;
      
      subjectListEl.style.display = 'none';
      modeChoiceEl.style.display = 'block';
      modalTitle.textContent = `${subject}: –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º`;
    });
    
    subjectListEl.appendChild(btn);
  });
}

// ====== –ù–ò–ñ–ù–ò–ô –ü–†–û–ì–†–ï–°–°-–ë–ê–† ======
function startBottomFill(ms){
  if (!autoSkipEl || !autoSkipEl.checked) return;
  if (bottomActive) return;
  
  bottomActive = true;
  bottomDuration = ms;
  bottomStart = null;
  bottomFill.style.width = '0%';
  bottomLabel.textContent = '0%';
  bottomCell.style.display = 'block';
  bottomCell.classList.add('visible');

  function step(ts){
    if (!bottomStart) bottomStart = ts;
    const elapsed = ts - bottomStart;
    const pct = Math.min(1, elapsed / bottomDuration);
    const pctInt = Math.round(pct * 100);
    bottomFill.style.width = pctInt + '%';
    bottomLabel.textContent = pctInt + '%';
    
    if (pct < 1){
      bottomAnim = requestAnimationFrame(step);
    } else {
      bottomAnim = null;
      bottomActive = false;
      if (autoSkipEl && autoSkipEl.checked){
        proceedToNext(true);
      }
    }
  }
  
  bottomAnim = requestAnimationFrame(step);
}

function stopBottomFill(){
  if (bottomAnim){ 
    cancelAnimationFrame(bottomAnim); 
    bottomAnim = null; 
  }
  bottomStart = null;
  bottomDuration = 0;
  bottomActive = false;
  bottomCell.classList.remove('visible');
  
  clearTimeout(bottomCell._hideTimeout);
  bottomCell._hideTimeout = setTimeout(() => {
    bottomCell.style.display = 'none';
    bottomFill.style.width = '0%';
    bottomLabel.textContent = '0%';
  }, 160);
}

function cancelBottomIfRunning(){
  stopBottomFill();
}

// ====== –ó–ê–ì–†–£–ó–ö–ê –í–û–ü–†–û–°–û–í –ò–ó –§–ê–ô–õ–ê ======
async function loadQuestionsFromFile(subject) {
  let fileName = '';
  switch(subject) {
    case 'Spring Framework':
      fileName = 'spring_questions.txt';
      break;
    case '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ü–û':
      fileName = 'architecture_questions.txt';
      break;
    case '–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å':
      fileName = 'cybersecurity_questions.txt';
      break;
    default:
      return [];
  }
  
  try {
    const response = await fetch(fileName);
    if (!response.ok) {
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª ${fileName}`);
    }
    const text = await response.text();
    return parseQuestions(text, subject);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞ "${subject}". –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ ${fileName}`);
    return [];
  }
}

function parseQuestions(text, subject) {
  const questions = [];
  const lines = text.split('\n');
  let currentQuestion = null;
  let questionNumber = 1;
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();
    
    if (line.startsWith('**') && line.includes('**')) {
      // –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
      if (currentQuestion && currentQuestion.question) {
        questions.push(currentQuestion);
      }
      const questionText = line.replace(/\*\*/g, '').trim();
      // –£–±–∏—Ä–∞–µ–º –Ω–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞ –∏–∑ —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
      const cleanQuestion = questionText.replace(/^\d+\.\s*/, '');
      currentQuestion = {
        question: cleanQuestion,
        questionNumber: questionNumber++,
        options: [],
        correctAnswers: [],
        explanation: ''
      };
    } else if (line.startsWith('- ') && currentQuestion) {
      // –í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞
      const option = line.substring(2).trim();
      currentQuestion.options.push(option);
    } else if (line.startsWith('<!-- -->') && currentQuestion) {
      // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
    } else if (line.includes('–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:') || line.includes('Correct answer:')) {
      // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
      if (currentQuestion) {
        const match = line.match(/\d+/g);
        if (match) {
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–æ–º–µ—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤ –≤ –∏–Ω–¥–µ–∫—Å—ã (0-based)
          currentQuestion.correctAnswers = match.map(num => parseInt(num) - 1);
        }
      }
    } else if (line && currentQuestion && line.length > 0 && 
               !line.startsWith('- ') && 
               !line.includes('–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:') &&
               !line.includes('Correct answer:')) {
      // –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
      if (currentQuestion.explanation) {
        currentQuestion.explanation += ' ' + line;
      } else {
        currentQuestion.explanation = line;
      }
    }
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å
  if (currentQuestion && currentQuestion.question) {
    questions.push(currentQuestion);
  }
  
  // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã
  if (questions.length === 0) {
    return createFallbackQuestions(subject);
  }
  
  return questions;
}

function createFallbackQuestions(subject) {
  // –†–µ–∑–µ—Ä–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º
  const fallbackQuestions = {
    'Spring Framework': [
      {
        question: "–ß—Ç–æ —Ç–∞–∫–æ–µ Spring Framework?",
        questionNumber: 1,
        options: [
          "–§—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ Java",
          "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö",
          "–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è",
          "–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞"
        ],
        correctAnswers: [0],
        explanation: "Spring Framework - —ç—Ç–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ Java."
      }
    ],
    '–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ü–û': [
      {
        question: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è?",
        questionNumber: 1,
        options: [
          "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã, –µ—ë –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ",
          "–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞",
          "–°–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã",
          "–†–∞–∑–º–µ—Ä –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã"
        ],
        correctAnswers: [0],
        explanation: "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ü–û –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∏—Å—Ç–µ–º—ã –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –µ—ë –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤."
      }
    ],
    '–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å': [
      {
        question: "–ß—Ç–æ —Ç–∞–∫–æ–µ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å?",
        questionNumber: 1,
        options: [
          "–ó–∞—â–∏—Ç–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –æ—Ç —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –∞—Ç–∞–∫",
          "–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è",
          "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö",
          "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤"
        ],
        correctAnswers: [0],
        explanation: "–ö–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è –∑–∞—â–∏—Ç–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ —Å–µ—Ç–µ–π."
      }
    ]
  };
  
  return fallbackQuestions[subject] || [];
}

// ====== –°–ï–°–°–ò–Ø –ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï ======
async function startSession(selectedMode, savedState = null) {
  mode = selectedMode;
  startModal.style.display = 'none';
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
  qtext.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...';
  optionsEl.innerHTML = '';
  actionBtn.disabled = true;
  finishBtn.style.display = 'inline-block'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
  currentQuestions = await loadQuestionsFromFile(selectedSubject);
  
  if (!currentQuestions || currentQuestions.length === 0) {
    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞ "${selectedSubject}"`);
    showSubjectSelection();
    return;
  }
  
  testTitle.textContent = `–¢–µ—Å—Ç: ${selectedSubject}`;
  testSubtitle.textContent = `–†–µ–∂–∏–º: ${mode === 'single' ? '–û–¥–∏–Ω —Ä–∞–∑' : 'Mastery'}`;
  
  if (savedState) {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    order = savedState.order;
    currentIndex = savedState.currentIndex;
    score = savedState.score;
    answered = savedState.answered;
    userSelections = savedState.userSelections;
    totalQuestionsInTest = savedState.totalQuestionsInTest;
    questionsAnswered = savedState.questionsAnswered;
  } else {
    // –ù–æ–≤–∞—è —Å–µ—Å—Å–∏—è
    order = shuffled(Array.from({length: currentQuestions.length}, (_, i) => i));
    currentIndex = 0;
    score = 0;
    answered = false;
    userSelections = {};
    totalQuestionsInTest = currentQuestions.length;
    questionsAnswered = 0;
  }
  
  renderCurrent();
  saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
}

function renderCurrent(){
  if (currentIndex >= order.length){ 
    showResults(); 
    return; 
  }
  
  const qidx = order[currentIndex];
  const q = currentQuestions[qidx];

  answered = false;
  feedbackEl.style.display = 'none';
  explainEl.style.display = 'none';
  optionsEl.innerHTML = '';
  actionBtn.disabled = true;
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è
  if (mode === 'single' && currentIndex === order.length - 1) {
    actionBtn.textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç';
  } else {
    actionBtn.textContent = '–°–ª–µ–¥—É—é—â–∏–π';
  }

  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞ (–Ω–µ –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ)
  const questionNumber = q.questionNumber || (currentIndex + 1);
  psmall.textContent = `–í–æ–ø—Ä–æ—Å ${questionNumber} –∏–∑ ${totalQuestionsInTest}`;
  const pct = Math.round(((currentIndex + 1) / order.length) * 100);
  progressBar.style.width = pct + '%';
  ppct.textContent = pct + '%';

  qtext.textContent = q ? q.question : '–í–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç';
  if (!q) { 
    optionsEl.innerHTML = '<div style="color:var(--muted);padding:12px;border-radius:8px;background:rgba(255,255,255,0.02)">–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>'; 
    prevBtn.disabled = true; 
    actionBtn.disabled = true; 
    return; 
  }

  const multi = isMulti(q);
  let pairs = q.options.map((t, i) => ({t, orig: i}));
  shuffleInPlace(pairs);

  pairs.forEach(pair => {
    const label = document.createElement('label');
    label.className = 'option';
    const input = document.createElement('input');
    input.type = multi ? 'checkbox' : 'radio';
    input.name = 'opt' + qidx;
    input.dataset.orig = String(pair.orig);
    const span = document.createElement('span'); 
    span.className = 'opt-text'; 
    span.textContent = pair.t;
    label.appendChild(input); 
    label.appendChild(span);
    optionsEl.appendChild(label);

    if (!multi){
      label.addEventListener('click', () => {
        if (answered) return;
        const chosen = Number(input.dataset.orig);
        userSelections[qidx] = [chosen];
        evaluateSingle(qidx, chosen);
      });
    }
  });

  if (multi){
    actionBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
    actionBtn.disabled = true;
    optionsEl.querySelectorAll('input').forEach(inp => inp.addEventListener('change', () => {
      actionBtn.disabled = optionsEl.querySelectorAll('input:checked').length === 0;
    }));
  } else {
    actionBtn.disabled = true;
  }

  prevBtn.disabled = currentIndex === 0;

  if (!(autoSkipEl && autoSkipEl.checked) && !bottomActive){
    bottomCell.style.display = 'none';
    bottomFill.style.width = '0%';
    bottomLabel.textContent = '0%';
  }
  
  saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
}

// ====== –ü–†–û–í–ï–†–ö–ê –û–¢–í–ï–¢–û–í ======
function evaluateSingle(qidx, chosenOrig){
  const q = currentQuestions[qidx];
  const correct = q.correctAnswers.includes(chosenOrig);

  optionsEl.querySelectorAll('.option').forEach(label => {
    label.style.pointerEvents = 'none';
    const orig = Number(label.querySelector('input').dataset.orig);
    label.classList.remove('correct','incorrect','selected');
    if (q.correctAnswers.includes(orig)) label.classList.add('correct');
    if (orig === chosenOrig && !correct) label.classList.add('incorrect');
    if (orig === chosenOrig) label.classList.add('selected');
  });

  feedbackEl.textContent = correct ? '‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ' : '‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
  feedbackEl.className = 'feedback ' + (correct ? 'correct' : 'incorrect');
  feedbackEl.style.display = 'block';
  
  if (q.explanation){ 
    explainEl.textContent = q.explanation; 
    explainEl.style.display = 'block'; 
  }

  if (correct) score++;
  answered = true;
  questionsAnswered++;
  actionBtn.disabled = false;

  if (autoSkipEl && autoSkipEl.checked){
    startBottomFill(3000);
  } else {
    if (!bottomActive) stopBottomFill();
  }
  
  saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
}

function evaluateMulti(qidx){
  const q = currentQuestions[qidx];
  const chosen = Array.from(optionsEl.querySelectorAll('input:checked')).map(i => Number(i.dataset.orig)).sort((a,b) => a-b);
  userSelections[qidx] = chosen.slice();
  const corr = q.correctAnswers.slice().sort((a,b) => a-b);
  const full = JSON.stringify(chosen) === JSON.stringify(corr);

  optionsEl.querySelectorAll('.option').forEach(label => {
    label.style.pointerEvents = 'none';
    const orig = Number(label.querySelector('input').dataset.orig);
    label.classList.remove('correct','incorrect','selected');
    if (corr.includes(orig)) label.classList.add('correct');
    if (chosen.includes(orig) && !corr.includes(orig)) label.classList.add('incorrect');
    if (chosen.includes(orig)) label.classList.add('selected');
  });

  feedbackEl.textContent = full ? '‚úì –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–∞–≤–∏–ª—å–Ω–æ' : '‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ';
  feedbackEl.className = 'feedback ' + (full ? 'correct' : 'incorrect');
  feedbackEl.style.display = 'block';
  
  if (q.explanation){ 
    explainEl.textContent = q.explanation; 
    explainEl.style.display = 'block'; 
  }

  if (full) score++;
  answered = true;
  questionsAnswered++;
  actionBtn.disabled = false;

  if (autoSkipEl && autoSkipEl.checked){
    startBottomFill(4500);
  } else {
    if (!bottomActive) stopBottomFill();
  }
  
  saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
}

// ====== –ü–ï–†–ï–•–û–î –ö –°–õ–ï–î–£–Æ–©–ï–ú–£ ======
function proceedToNext(isAuto){
  if (!isAuto){
    if (bottomActive) cancelBottomIfRunning();
  }

  if (currentIndex >= order.length) return;
  const qidx = order[currentIndex];
  const q = currentQuestions[qidx];

  if (isMulti(q) && !answered){
    evaluateMulti(qidx);
    return;
  }
  if (!isMulti(q) && !answered) return;

  let wasCorrect = false;
  if (isMulti(q)){
    const chosen = (userSelections[qidx] || []).slice().sort((a,b) => a-b);
    const corr = q.correctAnswers.slice().sort((a,b) => a-b);
    wasCorrect = JSON.stringify(chosen) === JSON.stringify(corr);
  } else {
    wasCorrect = q.correctAnswers.includes((userSelections[qidx] || [])[0]);
  }

  if (mode === 'mastery' && !wasCorrect){
    const gap = Math.floor(Math.random() * 3) + 5;
    const insertPos = Math.min(currentIndex + gap, order.length);
    order.splice(insertPos, 0, qidx);
  }

  currentIndex++;

  if (currentIndex >= order.length){ 
    showResults(); 
    return; 
  }
  
  renderCurrent();
}

// ====== –†–ï–ó–£–õ–¨–¢–ê–¢–´ ======
function showResults(){
  document.querySelector('.card').style.display = 'none';
  resultsEl.style.display = 'block';
  finalScore.textContent = `${score} / ${totalQuestionsInTest}`;
  
  const wrongAnswers = questionsAnswered - score;
  const percentage = totalQuestionsInTest > 0 ? Math.round((score / totalQuestionsInTest) * 100) : 0;
  
  correctAnswersEl.textContent = score;
  wrongAnswersEl.textContent = wrongAnswers;
  percentageEl.textContent = percentage + '%';
  totalAnsweredEl.textContent = questionsAnswered + ' –∏–∑ ' + totalQuestionsInTest;
  
  let message = '';
  if (percentage >= 90) message = '–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üéâ';
  else if (percentage >= 70) message = '–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üëç';
  else if (percentage >= 50) message = '–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ. üìö';
  else message = '–ù—É–∂–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å. üí™';
  
  resultMessage.textContent = message;
  
  // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  clearState();
}

function showConfirmFinishModal() {
  confirmModal.style.display = 'flex';
}

function hideConfirmFinishModal() {
  confirmModal.style.display = 'none';
}

function finishTest() {
  hideConfirmFinishModal();
  showSubjectSelection(); // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
}

function showSubjectSelection(){
  resultsEl.style.display = 'none';
  document.querySelector('.card').style.display = 'block';
  finishBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  
  testTitle.textContent = '–í—ã–±–æ—Ä —Ç–µ—Å—Ç–∞';
  testSubtitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è';
  
  subjectListEl.style.display = 'block';
  modeChoiceEl.style.display = 'none';
  modalTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç';
  startModal.style.display = 'flex';
  
  selectedSubject = '';
  document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('selected'));
  
  // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  clearState();
}

// ====== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ï–°–°–ò–ò –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ======
function checkSavedSession() {
  const savedState = loadState();
  if (savedState && savedState.selectedSubject) {
    const continueTest = confirm('–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É "' + savedState.selectedSubject + '". –•–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?');
    if (continueTest) {
      selectedSubject = savedState.selectedSubject;
      startSession(savedState.mode, savedState);
      return true;
    } else {
      clearState();
    }
  }
  return false;
}

// ====== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ======
actionBtn.addEventListener('click', () => {
  if (currentIndex === order.length - 1 && mode === 'single') {
    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å –≤ —Ä–µ–∂–∏–º–µ "–æ–¥–∏–Ω —Ä–∞–∑"
    finishTest(); // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  } else {
    proceedToNext(false);
  }
});

prevBtn.addEventListener('click', () => { 
  if (bottomActive) cancelBottomIfRunning(); 
  if (currentIndex > 0){ 
    currentIndex--; 
    renderCurrent(); 
  } 
});

finishBtn.addEventListener('click', showConfirmFinishModal);

confirmCancelBtn.addEventListener('click', hideConfirmFinishModal);
confirmFinishBtn.addEventListener('click', finishTest);

autoSkipEl.addEventListener('change', () => {
  if (!autoSkipEl.checked && bottomActive){
    stopBottomFill();
  }
});

singleBtn.addEventListener('click', () => startSession('single'));
masteryBtn.addEventListener('click', () => startSession('mastery'));

restartBtn.addEventListener('click', () => {
  if (selectedSubject) {
    startSession(mode);
  } else {
    showSubjectSelection();
  }
});

backToSubjectsBtn.addEventListener('click', showSubjectSelection);
backToSubjectsBtn2.addEventListener('click', () => {
  subjectListEl.style.display = 'block';
  modeChoiceEl.style.display = 'none';
  modalTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç';
});

themeBtn.addEventListener('click', () => document.documentElement.classList.toggle('light'));

document.addEventListener('keydown', (e) => { 
  if (e.key === 'Enter') proceedToNext(false); 
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ F5
document.addEventListener('keydown', function(e) {
  if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
    e.preventDefault();
    // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å
  }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function (e) {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–¥–µ—Ç –ª–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  if (selectedSubject && currentQuestions.length > 0) {
    e.preventDefault();
    e.returnValue = '–í—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç–µ —Ç–µ—Å—Ç. –í—Å–µ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
  }
});

// ====== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ======
function init() {
  initSubjectSelection();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é
  const hasSavedSession = checkSavedSession();
  
  if (!hasSavedSession && startModal) {
    startModal.style.display = 'flex';
  }
}

// –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
